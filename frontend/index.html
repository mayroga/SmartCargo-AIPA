<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SMARTCARGO-AIPA</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background-color: #f8f9fa; }
.accordion-button:not(.collapsed) { background-color: #0d6efd; color: white; }
.semaforo { font-size: 1.5rem; margin-left: 10px; }
.recommendation { margin-top: 10px; padding: 10px; border-radius: 5px; background-color: #e9ecef; }
</style>
</head>
<body>
<div class="container my-4">
  <h1 class="mb-4">SMARTCARGO-AIPA - Validaci√≥n de Carga</h1>

  <div class="mb-3">
    <label for="operator" class="form-label">Operador</label>
    <input type="text" id="operator" class="form-control" placeholder="Nombre del operador">
  </div>

  <div class="accordion" id="accordionQuestions">
    <!-- ====== Owner ====== -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingOwner">
        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOwner">
          Owner / Cliente
        </button>
      </h2>
      <div id="collapseOwner" class="accordion-collapse collapse show" data-bs-parent="#accordionQuestions">
        <div class="accordion-body" id="ownerQuestions"></div>
      </div>
    </div>
    <!-- ====== Trucker ====== -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingTrucker">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTrucker">
          Trucker / Chofer
        </button>
      </h2>
      <div id="collapseTrucker" class="accordion-collapse collapse" data-bs-parent="#accordionQuestions">
        <div class="accordion-body" id="truckerQuestions"></div>
      </div>
    </div>
    <!-- ====== Forwarder ====== -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingForwarder">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseForwarder">
          Freight Forwarder
        </button>
      </h2>
      <div id="collapseForwarder" class="accordion-collapse collapse" data-bs-parent="#accordionQuestions">
        <div class="accordion-body" id="forwarderQuestions"></div>
      </div>
    </div>
    <!-- ====== Counter ====== -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingCounter">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCounter">
          Counter / Operativo
        </button>
      </h2>
      <div id="collapseCounter" class="accordion-collapse collapse" data-bs-parent="#accordionQuestions">
        <div class="accordion-body" id="counterQuestions"></div>
      </div>
    </div>
    <!-- ====== DG ====== -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingDG">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDG">
          DG / Mercanc√≠as Peligrosas
        </button>
      </h2>
      <div id="collapseDG" class="accordion-collapse collapse" data-bs-parent="#accordionQuestions">
        <div class="accordion-body" id="dgQuestions"></div>
      </div>
    </div>
    <!-- ====== Misc ====== -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingMisc">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMisc">
          Miscel√°neos / Otros
        </button>
      </h2>
      <div id="collapseMisc" class="accordion-collapse collapse" data-bs-parent="#accordionQuestions">
        <div class="accordion-body" id="miscQuestions"></div>
      </div>
    </div>
  </div>

  <div class="mt-3">
    <button class="btn btn-success" id="validateBtn">Validar Carga</button>
  </div>

  <div class="mt-3">
    <span>Sem√°foro:</span><span id="semaforo" class="semaforo">üü¢</span>
  </div>

  <div id="recommendations" class="recommendation"></div>

  <div class="mt-3">
    <button class="btn btn-primary" id="pdfBtn">Generar PDF</button>
    <button class="btn btn-info" id="whatsappBtn">Enviar WhatsApp</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const apiBase = "http://localhost:8000"; // Cambiar al deploy real
let questions = [];

async function loadQuestions() {
  const res = await fetch(`${apiBase}/questions`);
  questions = await res.json();
  renderQuestions();
}

function renderQuestions() {
  const containers = {
    Owner: document.getElementById("ownerQuestions"),
    Trucker: document.getElementById("truckerQuestions"),
    Forwarder: document.getElementById("forwarderQuestions"),
    Counter: document.getElementById("counterQuestions"),
    DG: document.getElementById("dgQuestions"),
    Misc: document.getElementById("miscQuestions")
  };

  Object.values(containers).forEach(c => c.innerHTML = "");

  questions.forEach(q => {
    const div = document.createElement("div");
    div.className = "mb-2";
    let inputHtml = '';
    if(q.type === "boolean") {
      inputHtml = `<select class="form-select" data-qid="${q.id}">
                     <option value="">Seleccione</option>
                     <option value="ok">‚úî Cumple</option>
                     <option value="fail">‚ùå No cumple</option>
                   </select>`;
    } else {
      inputHtml = `<input type="${q.type}" class="form-control" data-qid="${q.id}" placeholder="Respuesta">`;
    }
    div.innerHTML = `<label>${q.question} (${q.role})</label>${inputHtml}`;
    containers[q.role].appendChild(div);
  });
}

async function validateCargo() {
  const answers = {};
  document.querySelectorAll('[data-qid]').forEach(el => {
    let val = el.value;
    if(val) answers[el.dataset.qid] = val;
  });

  const operator = document.getElementById("operator").value || "Unknown";

  const res = await fetch(`${apiBase}/validate`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({answers, operator})
  });

  const result = await res.json();
  updateUI(result);
}

function updateUI(result) {
  const semaforoEl = document.getElementById("semaforo");
  if(result.status === "GREEN") semaforoEl.textContent = "üü¢";
  else if(result.status === "YELLOW") semaforoEl.textContent = "üü°";
  else semaforoEl.textContent = "üî¥";

  const recsEl = document.getElementById("recommendations");
  recsEl.innerHTML = result.recommendations.join("<br>");
}

document.getElementById("validateBtn").addEventListener("click", validateCargo);

loadQuestions();
</script>
</body>
</html>

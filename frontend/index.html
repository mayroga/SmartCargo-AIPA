<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SMARTCARGO-AIPA</title>
<link rel="stylesheet" href="/static/styles.css">
<script defer src="/static/scripts.js"></script>
</head>
<body>

<div class="box">
    <h2>SMARTCARGO-AIPA</h2>
    <div class="banner">
        Avoid rejections 路 Delays 路 Fines 路 Save time, effort and money
    </div>

    <!--  REPORTE -->
    <p id="reportId" style="font-size:13px;color:#555;"></p>

    <select id="lang" onchange="switchLang()">
        <option value="English">English</option>
        <option value="Spanish">Spanish</option>
    </select>

    <label id="roleLabel">Role</label>
    <select id="role">
        <option>Shipper</option>
        <option>Driver</option>
        <option>Warehouse</option>
        <option>Counter</option>
    </select>

    <hr>

    <!-- BLOQUE DE INFORMACIN DE CARGA -->
    <div id="bloqueCarga">
        <h3>Informaci贸n de Carga</h3>

        <label>Tipo de Carga</label>
        <select id="tipoCarga" onchange="mostrarBloques()">
            <option value="">--Seleccionar--</option>
            <option value="perecederos">Perecederos</option>
            <option value="dg">DG / Peligrosa</option>
            <option value="normal">Normal / Mixta</option>
        </select>

        <label>Avi贸n</label>
        <select id="avion" onchange="mostrarBloques()">
            <option value="belly/pax">Belly / PAX</option>
            <option value="freighter">Freighter</option>
        </select>

        <label>Alto (cm)</label>
        <input type="number" id="alto" min="0" onchange="mostrarBloques()">

        <label>Peso seg煤n Gu铆a (kg)</label>
        <input type="number" id="pesoGuia" min="0" onchange="mostrarBloques()">

        <label>Peso Real (kg)</label>
        <input type="number" id="pesoReal" min="0" onchange="mostrarBloques()">
    </div>

    <!-- BLOQUES DINMICOS SEGN CARGA -->
    <div id="bloqueDG" class="hidden">
        <h3>Carga DG / Peligrosa</h3>
        <label>DGD firmado?</label>
        <select id="dgFirmado">
            <option value="no">No</option>
            <option value="yes">S铆</option>
        </select>
    </div>

    <div id="bloquePerish" class="hidden">
        <h3>Perecederos</h3>
        <label>Temperatura en rango</label>
        <select id="tempRango">
            <option value="fuera">Fuera</option>
            <option value="ok">Correcta</option>
        </select>
    </div>

    <div id="bloqueMadera" class="hidden">
        <h3>Embalaje</h3>
        <label>Madera con NIMF-15</label>
        <select id="maderaNIMF">
            <option value="no">No</option>
            <option value="yes">S铆</option>
        </select>
    </div>

    <button id="validateBtn" onclick="validate()">Validar Carga</button>
    <button onclick="clearAll()">Ч Limpiar</button>

    <!-- RESULTADO -->
    <div id="result" class="hidden">
        <h3 id="semaforo"></h3>
        <div id="analysis" class="analysis-box"></div>
        <button onclick="generarPDF()"> Generar PDF Certificado</button>
    </div>

    <hr>

    <!-- ADMIN -->
    <h3>Admin Login</h3>
    <input id="adminUser" placeholder="Username">
    <input id="adminPass" type="password" placeholder="Password">
    <textarea id="adminQ" placeholder="Pregunta al sistema"></textarea>
    <button onclick="adminAsk()">Preguntar</button>
    <pre id="adminAnswer"></pre>
</div>

<script>
/*  Generador de Reporte ID */
(function generateReportId() {
    const now = new Date();
    const id =
        "SCR-AIPA-" +
        now.getFullYear() +
        (now.getMonth()+1).toString().padStart(2,"0") +
        now.getDate().toString().padStart(2,"0") + "-" +
        Math.random().toString(36).substring(2,8).toUpperCase();
    document.getElementById("reportId").innerText =
        "Report ID: " + id + " 路 Generated: " + now.toLocaleString();
})();

/*  Cambiar idioma */
function switchLang() {
    roleLabel.innerText = lang.value === "Spanish" ? "Rol" : "Role";
}

/*  Mostrar bloques seg煤n cascada */
function mostrarBloques() {
    const tipo = document.getElementById("tipoCarga").value;
    const bloqueDG = document.getElementById("bloqueDG");
    const bloquePerish = document.getElementById("bloquePerish");
    const bloqueMadera = document.getElementById("bloqueMadera");

    bloqueDG.classList.add("hidden");
    bloquePerish.classList.add("hidden");
    bloqueMadera.classList.remove("hidden");

    if(tipo === "dg") bloqueDG.classList.remove("hidden");
    if(tipo === "perecederos") bloquePerish.classList.remove("hidden");
}

/*  VALIDAR CARGA */
function validate() {
    const data = new FormData();
    data.append("tipo_carga", document.getElementById("tipoCarga").value);
    data.append("avion", document.getElementById("avion").value);
    data.append("alto_cm", document.getElementById("alto").value);
    data.append("peso_guia", document.getElementById("pesoGuia").value);
    data.append("peso_real", document.getElementById("pesoReal").value);
    data.append("dg_firmado", document.getElementById("dgFirmado")?.value || "no");
    data.append("madera_nimf", document.getElementById("maderaNIMF")?.value || "no");
    data.append("temp_rango", document.getElementById("tempRango")?.value || "ok");

    fetch("/evaluar_carga", { method: "POST", body: data })
        .then(r => r.json())
        .then(showResult);
}

/*  Mostrar resultado con sem谩foro */
function showResult(res) {
    document.getElementById("result").classList.remove("hidden");

    const semaforo = document.getElementById("semaforo");
    semaforo.innerText =
        res.semaforo === "ROJO" ? " RECHAZADO" :
        res.semaforo === "AMARILLO" ? " CORREGIR" :
        " ACEPTADO";

    semaforo.style.color =
        res.semaforo === "ROJO" ? "red" :
        res.semaforo === "AMARILLO" ? "orange" :
        "green";

    const analysis = document.getElementById("analysis");
    analysis.innerHTML = "<strong>Observaciones:</strong><br>" + res.mensaje.join("<br>") +
        "<br><strong>Acci贸n sugerida:</strong><br>" + res.solucion.join("<br>");
}

/* Ч Limpiar */
function clearAll() {
    document.getElementById("tipoCarga").value = "";
    document.getElementById("avion").value = "belly/pax";
    document.getElementById("alto").value = "";
    document.getElementById("pesoGuia").value = "";
    document.getElementById("pesoReal").value = "";
    document.getElementById("dgFirmado").value = "no";
    document.getElementById("maderaNIMF").value = "no";
    document.getElementById("tempRango").value = "ok";
    document.getElementById("result").classList.add("hidden");
    document.getElementById("analysis").innerHTML = "";
}

/*  GENERAR PDF */
function generarPDF() {
    alert("PDF generado con certificado legal (simulaci贸n). Implementar endpoint /generar_pdf para PDF real.");
}

/*  ADMIN */
function adminAsk() {
    const data = new FormData();
    data.append("username", document.getElementById("adminUser").value);
    data.append("password", document.getElementById("adminPass").value);
    data.append("question", document.getElementById("adminQ").value);

    fetch("/admin", { method: "POST", body: data })
        .then(r => r.json())
        .then(r => document.getElementById("adminAnswer").innerText = r.answer || "Unauthorized");
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SMARTCARGO-AIPA</title>
<style>
  body {
    font-family: "Segoe UI", Arial, sans-serif;
    background: #f2f4f7;
    margin: 0;
    padding: 0;
  }
  .container {
    max-width: 1200px;
    margin: 30px auto;
    background: #ffffff;
    padding: 30px 40px;
    border-radius: 14px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
  }
  h1 { margin-top: 0; color: #002b5c; }
  .subtitle { color: #555; margin-bottom: 30px; }
  .level { margin-bottom: 25px; border: 1px solid #ddd; border-radius: 10px; overflow: hidden; }
  .level-header { background: #004080; color: white; padding: 14px 18px; font-size: 17px; cursor: pointer; }
  .level-content { display: none; padding: 20px; background: #fafafa; }
  .question { margin-bottom: 22px; }
  .question-title { font-weight: 600; margin-bottom: 10px; color: #222; }
  .options label { display: block; margin-bottom: 6px; cursor: pointer; }
  .options input { margin-right: 8px; }
  .actions { text-align: center; margin-top: 35px; }
  button { background: #004080; color: white; border: none; padding: 14px 26px; font-size: 16px; border-radius: 8px; cursor: pointer; margin: 8px; }
  button:hover { background: #0066cc; }
  #result { margin-top: 35px; padding: 25px; border-radius: 12px; display: none; }
  #semaphore { font-size: 22px; font-weight: bold; margin-bottom: 15px; }
  .green { color: #0a8f08; }
  .yellow { color: #d4a000; }
  .red { color: #c00000; }
  .recommendations { margin-top: 15px; font-size: 15px; }
  #login-box { margin-bottom: 25px; padding: 20px; background: #eef2f7; border-radius: 12px; }
  #login-box input { padding: 10px; width: 200px; margin-right: 10px; border-radius: 6px; border: 1px solid #ccc; }
</style>
</head>

<body>

<div class="container">
  <h1>SMARTCARGO-AIPA</h1>
  <p class="subtitle">
    Preventive Cargo Acceptance Advisory System<br>
    Operational Â· Legal Â· Non-binding
  </p>

  <!-- ================= LOGIN ================= -->
  <div id="login-box">
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <p id="login-msg" style="color:red;"></p>
  </div>

  <!-- ================= LEVELS ================= -->
  <div id="questions-section" style="display:none;">

    <!-- LEVEL 1 EXAMPLE -->
    <div class="level">
      <div class="level-header" onclick="toggleLevel(this)">Level 1 â€“ Identification & Transport</div>
      <div class="level-content">
        <div class="question">
          <div class="question-title">1. Type of cargo</div>
          <div class="options">
            <label><input type="radio" name="q1" value="ok"> Pharmaceutical</label>
            <label><input type="radio" name="q1" value="warn"> DG</label>
            <label><input type="radio" name="q1" value="warn"> Perishable</label>
            <label><input type="radio" name="q1" value="ok"> Human Remains</label>
            <label><input type="radio" name="q1" value="ok"> General Cargo</label>
            <label><input type="radio" name="q1" value="ok"> Other</label>
          </div>
        </div>

        <div class="question">
          <div class="question-title">2. Delivered by</div>
          <div class="options">
            <label><input type="radio" name="q2" value="ok"> Authorized Driver</label>
            <label><input type="radio" name="q2" value="ok"> Freight Forwarder</label>
            <label><input type="radio" name="q2" value="ok"> Company</label>
            <label><input type="radio" name="q2" value="warn"> Owner personally</label>
          </div>
        </div>
      </div>
    </div>

    <!-- LEVEL 2 EXAMPLE -->
    <div class="level">
      <div class="level-header" onclick="toggleLevel(this)">Level 2 â€“ Documentation</div>
      <div class="level-content">
        <div class="question">
          <div class="question-title">9. Original AWB present</div>
          <div class="options">
            <label><input type="radio" name="q9" value="ok"> Inside envelope</label>
            <label><input type="radio" name="q9" value="warn"> Loose</label>
            <label><input type="radio" name="q9" value="fail"> Not available</label>
          </div>
        </div>

        <div class="question">
          <div class="question-title">12. Shipper name matches documents</div>
          <div class="options">
            <label><input type="radio" name="q12" value="ok"> Yes</label>
            <label><input type="radio" name="q12" value="warn"> Unclear</label>
            <label><input type="radio" name="q12" value="fail"> No</label>
          </div>
        </div>
      </div>
    </div>

    <!-- ================= ACTIONS ================= -->
    <div class="actions">
      <button onclick="submitForm()">Validate Cargo</button>
      <button onclick="location.reload()">Clear</button>
      <button id="pdf-btn" style="display:none;" onclick="downloadPDF()">Download PDF</button>
    </div>

    <!-- ================= RESULT ================= -->
    <div id="result">
      <div id="semaphore"></div>
      <div class="recommendations" id="recommendations"></div>
    </div>

  </div>
</div>

<script>
function toggleLevel(el) {
  const content = el.nextElementSibling;
  content.style.display = content.style.display === "block" ? "none" : "block";
}

// ================= LOGIN =================
let loggedUser = "";
function login() {
  const username = document.getElementById("username").value;
  const password = document.getElementById("password").value;
  fetch("/login", {
    method: "POST",
    body: new URLSearchParams({username, password})
  })
  .then(r => {
    if (!r.ok) throw new Error("Login failed");
    return r.json();
  })
  .then(res => {
    loggedUser = username;
    document.getElementById("login-box").style.display = "none";
    document.getElementById("questions-section").style.display = "block";
  })
  .catch(err => {
    document.getElementById("login-msg").innerText = "Invalid username or password";
  });
}

// ================= VALIDATE FORM =================
let lastResult = {};
function submitForm() {
  const answers = {};
  document.querySelectorAll("input[type=radio]:checked").forEach(r => {
    answers[r.name] = r.value;
  });
  if (Object.keys(answers).length === 0) { alert("Please select answers"); return; }

  fetch("/validate", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ answers, operator: loggedUser })
  })
  .then(r => r.json())
  .then(res => {
    lastResult = res;
    showResult(res);
    document.getElementById("pdf-btn").style.display = "inline-block";
  })
  .catch(() => alert("Validation service unavailable"));
}

// ================= SHOW RESULT =================
function showResult(res) {
  const box = document.getElementById("result");
  const sem = document.getElementById("semaphore");
  const rec = document.getElementById("recommendations");

  box.style.display = "block";

  if (res.status === "GREEN") {
    sem.innerHTML = "ðŸŸ¢ ACCEPTABLE FOR CARGO";
    sem.className = "green";
  } else if (res.status === "YELLOW") {
    sem.innerHTML = "ðŸŸ¡ CONDITIONAL â€“ REVIEW REQUIRED";
    sem.className = "yellow";
  } else {
    sem.innerHTML = "ðŸ”´ NOT ACCEPTABLE â€“ ACTION REQUIRED";
    sem.className = "red";
  }

  rec.innerHTML = res.recommendations.map(r => r.replace(/\|/g, "<br>")).join("<br>");
}

// ================= DOWNLOAD PDF =================
function downloadPDF() {
  const recs = lastResult.recommendations.join("|");
  const url = `/pdf/${lastResult.report_id}?operator=${encodeURIComponent(lastResult.operator)}&status=${lastResult.status}&recs=${encodeURIComponent(recs)}`;
  window.open(url, "_blank");
}
</script>

</body>
</html>

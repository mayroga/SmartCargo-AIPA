<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SMARTCARGO-AIPA by May Roga LLC</title>
<link rel="stylesheet" href="/static/styles.css">
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<div class="box">
    <h1 id="title">SMARTCARGO-AIPA</h1>
    <button onclick="switchLang()">
        <span id="lang-btn">Español</span>
    </button>

    <h3>Shipment AWB / Cargo Input</h3>
    <label>Role</label>
    <select id="role">
        <option value="SHIPPER">Shipper</option>
        <option value="FORWARDER">Forwarder</option>
        <option value="TRUCKER">Trucker</option>
        <option value="OWNER">Owner</option>
        <option value="COUNTER">Counter</option>
        <option value="DG_OFFICER">DG Officer</option>
    </select>

    <textarea id="awb" placeholder="Paste AWB / shipment info here"></textarea>
    <input type="file" id="files" multiple />

    <button id="validateBtn" onclick="validate()">Evaluate Shipment</button>
    <button onclick="exportPDF()">Export PDF</button>
    <button onclick="sendWhatsApp()">Send WhatsApp</button>

    <div id="result" class="hidden">
        <h3>Checklist Results</h3>
        <div id="analysis" class="analysis-box"></div>
        <div id="docs" class="analysis-box"></div>
    </div>
</div>

<script>
let currentLang = "EN";

function switchLang() {
    if(currentLang === "EN") {
        currentLang = "ES";
        document.getElementById("title").innerText = "SMARTCARGO-AIPA";
        document.getElementById("awb").placeholder = "Pegue información del AWB aquí";
        document.getElementById("validateBtn").innerText = "Evaluar Carga";
        document.getElementById("lang-btn").innerText = "English";
    } else {
        currentLang = "EN";
        document.getElementById("title").innerText = "SMARTCARGO-AIPA";
        document.getElementById("awb").placeholder = "Paste AWB / shipment info here";
        document.getElementById("validateBtn").innerText = "Evaluate Shipment";
        document.getElementById("lang-btn").innerText = "Español";
    }
}

async function validate() {
    const role = document.getElementById("role").value;
    const awbText = document.getElementById("awb").value;
    const filesInput = document.getElementById("files");

    const payload = {
        role: role,
        shipment_number: "AWB12345",
        origin: "MIA",
        destination: "BOG",
        total_weight_kg: 0,
        total_pieces: 0,
        pieces: [],
        documents: [],
        comments: awbText
    };

    // Files
    const files = filesInput.files;
    for(let i=0;i<files.length;i++){
        const formData = new FormData();
        formData.append("file", files[i]);
        const res = await axios.post("/upload", formData, { headers: { "Content-Type": "multipart/form-data" } });
        payload.documents.push(res.data.filename);
    }

    const res = await axios.post("/evaluate", payload);
    document.getElementById("result").classList.remove("hidden");

    let html = "";
    res.data.results.forEach(r => {
        html += `<b>Piece ${r.piece_id || "General"}:</b> ${r.alert} <br>${r.observation}<hr>`;
    });
    html += `<h4>AI Recommendations:</h4><pre>${res.data.ai_observation}</pre>`;
    document.getElementById("analysis").innerHTML = html;

    // Show uploaded documents visually
    let docsHTML = "";
    payload.documents.forEach(d => {
        docsHTML += `<a href="/storage/uploads/${d}" target="_blank">${d}</a><br>`;
    });
    document.getElementById("docs").innerHTML = docsHTML;
}

function sendWhatsApp() {
    const text = encodeURIComponent(document.getElementById("analysis").innerText);
    window.open(`https://wa.me/?text=${text}`, "_blank");
}

function exportPDF() {
    const content = document.getElementById("analysis").innerText + "\n" + document.getElementById("docs").innerText;
    const blob = new Blob([content], {type:"text/plain"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "SMARTCARGO_report.txt";
    link.click();
}
</script>
</body>
</html>

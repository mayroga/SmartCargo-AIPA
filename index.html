<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartCargo-AIPA Console</title>
    <style>
        :root { --red: #d32f2f; --gold: #c5a059; --dark: #02060c; --white: #ffffff; }
        body { background: var(--dark); color: var(--white); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 15px; }
        
        .main-container { max-width: 800px; margin: auto; display: flex; flex-direction: column; gap: 15px; }
        
        /* Inputs Limpios */
        .tech-grid { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; gap: 10px; }
        input, textarea { background: #111; border: 1px solid #333; color: var(--gold); padding: 12px; border-radius: 5px; font-size: 16px; width: 100%; box-sizing: border-box; }
        input:focus { border-color: var(--gold); outline: none; }

        /* Botonera de Acci√≥n */
        .actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        button { padding: 18px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .btn-voice { background: var(--gold); color: #000; grid-column: span 3; font-size: 18px; }
        .btn-solve { background: var(--red); color: #fff; }
        .btn-clear { background: #333; color: #ccc; }
        .btn-print { background: #fff; color: #000; }

        /* Pantalla de Resultados - Estilo Terminal */
        #resDisplay { background: #000; border: 1px solid var(--gold); padding: 20px; border-radius: 5px; min-height: 200px; white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 14px; display: none; overflow-x: auto; }
        table { border-collapse: collapse; width: 100%; color: #0f0; border: 1px solid #0f0; margin: 10px 0; }
        th, td { border: 1px solid #0f0; padding: 8px; text-align: left; }
    </style>
</head>
<body>

<div class="main-container">
    <div style="text-align: center;">
        <h1 style="color: var(--red); margin: 0; letter-spacing: 2px;">SMARTCARGO ADVISOR</h1>
        <p style="color: var(--gold); margin: 0; font-size: 12px;">AVIANCA SPECIALIST SYSTEM | HUB MIA</p>
    </div>

    <div class="tech-grid">
        <input type="text" id="awb" placeholder="AWB / ULD">
        <input type="number" id="L" placeholder="L">
        <input type="number" id="W" placeholder="W">
        <input type="number" id="H" placeholder="H">
        <input type="number" id="wgt" placeholder="KG">
    </div>

    <button class="btn-voice" id="voiceBtn">üé§ INICIAR REPORTE POR VOZ</button>
    
    <textarea id="obs" rows="4" placeholder="Dictado t√©cnico: 'Tengo carga perecedera, falta el log de temp...'"></textarea>

    <div class="actions">
        <button class="btn-clear" onclick="clearAll()">üóëÔ∏è BORRAR</button>
        <button class="btn-solve" onclick="resolve()">RESOLVER AHORA</button>
        <button class="btn-print" onclick="window.print()">üìÑ PDF</button>
    </div>

    <div id="resDisplay"></div>
</div>

<script>
    let chatHistory = "";
    const voiceBtn = document.getElementById('voiceBtn');
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'es-ES';
    recognition.continuous = false;

    voiceBtn.onmousedown = voiceBtn.ontouchstart = (e) => {
        e.preventDefault();
        recognition.start();
        voiceBtn.innerText = "üî¥ ESCUCHANDO...";
        voiceBtn.style.background = "#ff0000";
    };

    voiceBtn.onmouseup = voiceBtn.ontouchend = () => {
        recognition.stop();
        voiceBtn.innerText = "üé§ INICIAR REPORTE POR VOZ";
        voiceBtn.style.background = "var(--gold)";
    };

    recognition.onresult = (e) => {
        document.getElementById('obs').value += " " + e.results[0][0].transcript;
    };

    function clearAll() {
        document.querySelectorAll('input, textarea').forEach(i => i.value = "");
        document.getElementById('resDisplay').style.display = "none";
        chatHistory = "";
    }

    async function resolve() {
        const display = document.getElementById('resDisplay');
        display.style.display = "block";
        display.innerText = "> ACCEDIENDO A PROTOCOLOS IATA/AVIANCA...";

        const fd = new FormData();
        fd.append('prompt', document.getElementById('obs').value);
        fd.append('awb', document.getElementById('awb').value);
        fd.append('l', document.getElementById('L').value);
        fd.append('w', document.getElementById('W').value);
        fd.append('h', document.getElementById('H').value);
        fd.append('wgt', document.getElementById('wgt').value);
        fd.append('context_history', chatHistory);

        try {
            const res = await fetch('/advisory', { method: 'POST', body: fd });
            const result = await res.json();
            
            // Renderizar tablas Markdown si existen
            display.innerHTML = formatMarkdown(result.data);
            chatHistory += "\n" + result.data;
        } catch (err) {
            display.innerText = "ERROR CR√çTICO: CORE NO RESPONDE.";
        }
    }

    function formatMarkdown(text) {
        // Simple conversor de tablas para la terminal
        return text.replace(/\n/g, "<br>");
    }
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartCargo-AIPA | Avianca</title>
    <style>
        :root { --red: #d32f2f; --gold: #c5a059; --dark: #0a192f; }
        body { background: #000; color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 10px; }
        .card { background: #fff; color: #333; border-radius: 15px; padding: 20px; max-width: 500px; margin: auto; }
        input, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        .photo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .photo-box { height: 110px; border: 2px dashed var(--gold); border-radius: 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; cursor: zoom-in; }
        .photo-box img { width: 100%; height: 100%; object-fit: cover; }
        .btn-voice { width: 100%; padding: 15px; background: var(--dark); color: var(--gold); border: 2px solid var(--gold); border-radius: 10px; font-weight: bold; margin-bottom: 10px; cursor: pointer; user-select: none; -webkit-tap-highlight-color: transparent; }
        .btn-exec { width: 100%; padding: 20px; background: var(--red); color: #fff; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        #resBox { display: none; margin-top: 15px; padding: 15px; background: #f0f0f0; border-left: 5px solid var(--gold); border-radius: 8px; color: #000; }
    </style>
</head>
<body>
    <div class="card">
        <h2 style="text-align:center; color:var(--red); margin:0;">SmartCargo-AIPA</h2>
        <p style="text-align:center; font-size:11px; color:var(--gold); font-weight:bold;">MAESTRO DE CARGA Y LOG칈STICA</p>
        
        <input type="text" id="awb" placeholder="N칰mero AWB / Identificador ULD">
        
        <div style="display:flex; gap:5px;">
            <input type="number" id="L" placeholder="L (pulg)">
            <input type="number" id="W" placeholder="W">
            <input type="number" id="H" placeholder="H">
        </div>

        <div class="photo-grid">
            <div class="photo-box" onclick="handleImg(this)"><img id="v1" style="display:none;"><span>游닞 PAPELES</span><input type="file" id="f1" hidden onchange="preview(this,'v1')"></div>
            <div class="photo-box" onclick="handleImg(this)"><img id="v2" style="display:none;"><span>游닞 CARGA</span><input type="file" id="f2" hidden onchange="preview(this,'v2')"></div>
        </div>

        <button class="btn-voice" id="voiceBtn">游꿗 MANT칄N PARA DICTAR REPORTE</button>
        <textarea id="obs" rows="3" placeholder="Describe el documento, la discrepancia o pide una lecci칩n..."></textarea>
        
        <button class="btn-exec" onclick="sendToAIPA()">Ejecutar An치lisis Maestro</button>

        <div id="resBox">
            <div id="resTxt" style="font-size:14px; white-space:pre-wrap;"></div>
            <button onclick="listen()" style="width:100%; padding:10px; margin-top:10px; background:var(--dark); color:#fff; border-radius:8px;">游댉 Escuchar Instrucciones</button>
        </div>
    </div>

    <script>
        // Funci칩n de Imagen: Zoom o Carga
        function handleImg(el) {
            const img = el.querySelector('img');
            if(img.style.display === "none") { el.querySelector('input').click(); }
            else { img.style.transform = img.style.transform === "scale(2.5)" ? "scale(1)" : "scale(2.5)"; img.style.zIndex = "100"; }
        }

        function preview(input, id) {
            const reader = new FileReader();
            reader.onload = e => { 
                const img = document.getElementById(id);
                img.src = e.target.result; img.style.display = "block";
                img.nextElementSibling.style.display = "none";
            };
            reader.readAsDataURL(input.files[0]);
        }

        // Sistema de Voz: Push-to-Talk
        const voiceBtn = document.getElementById('voiceBtn');
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'es-ES'; recognition.continuous = true;

        const startVoice = (e) => { e.preventDefault(); recognition.start(); voiceBtn.style.background = "red"; voiceBtn.innerText = "游댮 ESCUCHANDO..."; };
        const stopVoice = () => { recognition.stop(); voiceBtn.style.background = ""; voiceBtn.innerText = "游꿗 MANT칄N PARA DICTAR REPORTE"; };

        voiceBtn.onmousedown = voiceBtn.ontouchstart = startVoice;
        voiceBtn.onmouseup = voiceBtn.ontouchend = stopVoice;

        recognition.onresult = (e) => {
            document.getElementById('obs').value = e.results[e.results.length - 1][0].transcript;
        };

        // Comunicaci칩n con el Servidor
        async function sendToAIPA() {
            const txt = document.getElementById('resTxt');
            document.getElementById('resBox').style.display = "block";
            txt.innerText = "Analizando papeler칤a y carga... Maestro SmartCargo procesando.";

            const fd = new FormData();
            fd.append('prompt', document.getElementById('obs').value);
            fd.append('awb', document.getElementById('awb').value);
            fd.append('l', document.getElementById('L').value);
            fd.append('w', document.getElementById('W').value);
            fd.append('h', document.getElementById('H').value);

            try {
                const response = await fetch('/advisory', { method: 'POST', body: fd });
                const result = await response.json();
                txt.innerText = result.data;
            } catch (err) {
                txt.innerText = "Error: Verifica la GEMINI_API_KEY en Render.";
            }
        }

        function listen() {
            window.speechSynthesis.speak(new SpeechSynthesisUtterance(document.getElementById('resTxt').innerText));
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartCargo-AIPA Resiliente</title>
    <style>
        :root { --red: #d32f2f; --gold: #c5a059; --dark: #0a192f; }
        body { background: #000; color: #fff; font-family: sans-serif; padding: 10px; margin: 0; }
        .card { background: #fff; color: #333; border-radius: 15px; padding: 15px; max-width: 450px; margin: auto; }
        input, textarea { width: 100%; padding: 10px; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        .photo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .photo-box { height: 100px; border: 2px dashed var(--gold); border-radius: 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; cursor: zoom-in; }
        .photo-box img { width: 100%; height: 100%; object-fit: cover; }
        .btn-voice { width: 100%; padding: 15px; background: var(--dark); color: var(--gold); border: 2px solid var(--gold); border-radius: 10px; font-weight: bold; margin-bottom: 10px; cursor: pointer; }
        .btn-exec { width: 100%; padding: 18px; background: var(--red); color: #fff; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        #resBox { display: none; margin-top: 15px; padding: 15px; background: #f0f0f0; border-left: 5px solid var(--gold); border-radius: 8px; color: #000; }
        .vip-active { background: var(--gold) !important; color: white !important; }
    </style>
</head>
<body>
    <div class="card">
        <h2 style="text-align:center; color:var(--red); margin:0;">SmartCargo-AIPA</h2>
        <p style="text-align:center; font-size:10px; color:var(--gold); margin-bottom:10px;">RESPALDO AUTOM√ÅTICO ACTIVADO</p>
        
        <input type="text" id="awb" placeholder="AWB / ULD #">
        <div style="display:flex; gap:5px;">
            <input type="number" id="L" placeholder="L"><input type="number" id="W" placeholder="W"><input type="number" id="H" placeholder="H">
        </div>

        <div class="photo-grid">
            <div class="photo-box" onclick="z(this)"><img id="v1" style="display:none;"><span>üì∏ DOCS</span><input type="file" id="f1" hidden onchange="pv(this,'v1')"></div>
            <div class="photo-box" onclick="z(this)"><img id="v2" style="display:none;"><span>üì∏ CARGO</span><input type="file" id="f2" hidden onchange="pv(this,'v2')"></div>
        </div>

        <button class="btn-voice" id="voiceBtn">üé§ MANT√âN PARA DICTAR</button>
        <button id="vipBtn" onclick="toggleVip()" style="width:100%; padding:10px; border:1px solid var(--gold); border-radius:10px; margin-bottom:10px; font-weight:bold; cursor:pointer;">üíé ACLARAR DUDAS (MODO MAESTRO)</button>
        <textarea id="obs" rows="3" placeholder="Describe carga o pide lecci√≥n..."></textarea>
        
        <button class="btn-exec" onclick="enviar()">EJECUTAR AN√ÅLISIS</button>

        <div id="resBox">
            <small id="sourceTag" style="color:var(--gold); font-weight:bold;"></small>
            <div id="resTxt" style="font-size:13px; white-space:pre-wrap; margin-top:5px;"></div>
            <button onclick="hablar()" style="width:100%; padding:10px; margin-top:10px; background:var(--dark); color:#fff; border-radius:8px;">üîä ESCUCHAR</button>
        </div>
    </div>

    <script>
        let isVip = false;
        function toggleVip() { isVip = !isVip; document.getElementById('vipBtn').classList.toggle('vip-active'); }

        function z(el) {
            const img = el.querySelector('img');
            if(img.style.display === "none") el.querySelector('input').click();
            else img.style.transform = img.style.transform === "scale(2.5)" ? "scale(1)" : "scale(2.5)";
        }

        function pv(input, id) {
            const r = new FileReader();
            r.onload = e => { const i = document.getElementById(id); i.src = e.target.result; i.style.display = "block"; i.nextElementSibling.style.display = "none"; };
            r.readAsDataURL(input.files[0]);
        }

        const voiceBtn = document.getElementById('voiceBtn');
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'es-ES'; recognition.continuous = true;

        voiceBtn.onmousedown = voiceBtn.ontouchstart = (e) => { e.preventDefault(); recognition.start(); voiceBtn.style.background = "red"; };
        voiceBtn.onmouseup = voiceBtn.ontouchend = () => { recognition.stop(); voiceBtn.style.background = ""; };
        recognition.onresult = (e) => { document.getElementById('obs').value = e.results[e.results.length-1][0].transcript; };

        async function enviar() {
            const resBox = document.getElementById('resBox');
            const resTxt = document.getElementById('resTxt');
            resBox.style.display = "block";
            resTxt.innerText = "Sincronizando con Hub de Inteligencia...";

            const fd = new FormData();
            fd.append('prompt', document.getElementById('obs').value);
            fd.append('awb', document.getElementById('awb').value);
            fd.append('l', document.getElementById('L').value);
            fd.append('w', document.getElementById('W').value);
            fd.append('h', document.getElementById('H').value);
            fd.append('clear_doubts', isVip);

            try {
                const response = await fetch('/advisory', { method: 'POST', body: fd });
                const result = await response.json();
                resTxt.innerText = result.data;
                document.getElementById('sourceTag').innerText = result.source;
            } catch (err) {
                resTxt.innerText = "Error total de conexi√≥n. Revise que las API Keys est√©n en Render.";
            }
        }

        function hablar() { window.speechSynthesis.speak(new SpeechSynthesisUtterance(document.getElementById('resTxt').innerText)); }
    </script>
</body>
</html>
